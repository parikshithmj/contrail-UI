var express = require('express');
var app = express();

app.use(express.static('html'));
app.use(express.static('images'));
app.use(express.static('public'));
var http = require("http");
var MongoClient = require('mongodb').MongoClient;



app.get('/traffics', function(req, res){

  MongoClient.connect("mongodb://parikshith:parikshith@ds023510.mlab.com:23510/contraildb", function(err, db) {
    var collection = db.collection('traffic');
    collection.find().toArray(function(err, items) {
	res.send(items);    
	});
  });

});

app.get('/traffics/:protocol/:destination_ip/:source_ip', function(req, res){
  var timestampBegin = Number(req.params.timestampBegin);
  var timestampEnd = Number(req.params.timestampEnd);
  var protocol = Number(req.params.protocol);
  var destination_ip = Number(req.params.destination_ip);
  var source_ip = Number(req.params.source_ip);

  console.log(timestampBegin+" :"+timestampEnd+":"+source_ip);
  var result =[];
  MongoClient.connect("mongodb://parikshith:parikshith@ds023510.mlab.com:23510/contraildb", function(err, db) {
    var collection = db.collection('traffic');
    collection.find().toArray(function(err, items) {
	for(var i = 0; i<items.length; i++){	
		if(items[i].protocol == protocol || items	  
      		[i].destination_ip == destination_ip && items[i].source_ip == source_ip){
			result.push(items[i]);
		}
	}
	res.send(result);    

	});
  });

});


app.get('/traffic/:protocol?', function(req, res){

  var protocol = Number(req.query.protocol);
  var result =[];
  MongoClient.connect("mongodb://parikshith:parikshith@ds023510.mlab.com:23510/contraildb", function(err, db) {
    var collection = db.collection('traffic');
    collection.find().toArray(function(err, items) {
	for(var i = 0; i<items.length; i++){	
		if(items[i].protocol == protocol){
			result.push(items[i]);
		}
	}
	res.send(result);    
	});
  });

});

app.get('/traffic/timeRange/:timestampBegin/:timestampEnd', function(req, res){
  console.log("Timerange api invoked");
  var timestampBegin = Number(req.params.timestampBegin);
  var timestampEnd = Number(req.params.timestampEnd);
    var result =[];
  MongoClient.connect("mongodb://parikshith:parikshith@ds023510.mlab.com:23510/contraildb", function(err, db) {
    var collection = db.collection('traffic');
    collection.find().toArray(function(err, items) {
	for(var i = 0; i<items.length; i++){	
		if(items[i].timestamp >= timestampBegin && items[i].timestamp <= timestampEnd){
			result.push(items[i]);
		}
	}
	res.send(result);    
	});
  });

});

console.log("Listening on port"+3000);
app.listen(3000);


  

